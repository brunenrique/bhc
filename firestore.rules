rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check user roles from token claims
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole() {
      return request.auth.token.role; // Assumes 'role' is a custom claim in the auth token
    }

    function isPsychologist() {
      return isSignedIn() && getUserRole() == 'psychologist';
    }

    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }
    
    function isSecretary() {
      return isSignedIn() && getUserRole() == 'secretary';
    }

    // Rules for 'patients' collection
    match /patients/{patientId} {
      // Allow create:
      // - Psychologists can create patients (and should ideally set themselves as psychologistId).
      // - Admins can create patients.
      allow create: if isPsychologist() || isAdmin();

      // Allow read:
      // - Psychologists can read any patient (in a real app, might restrict to their own).
      // - Admins can read any patient.
      // - Secretaries can read any patient.
      allow read: if isPsychologist() || isAdmin() || isSecretary();
      
      // Allow update:
      // - Psychologists can update any patient (in a real app, might restrict to their own).
      // - Admins can update any patient.
      allow update: if isPsychologist() || isAdmin();

      // Allow delete:
      // - Admins can delete patients.
      // - Psychologists can delete patients (in a real app, might restrict to their own or add soft delete).
      allow delete: if isAdmin() || isPsychologist();
    }

    // Example for user profiles - only the user themselves or an admin can modify
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if request.auth.uid == userId || isAdmin();
    }

    // Add rules for other collections as needed (e.g., sessions, assessments)
    // match /sessions/{sessionId} {
    //   // Define rules for sessions
    // }
    // match /assessments/{assessmentId} {
    //   // Define rules for assessments
    // }
  }
}
